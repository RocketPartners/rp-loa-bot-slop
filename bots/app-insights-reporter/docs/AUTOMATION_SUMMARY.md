# LoA Application Insights Automation - Complete Summary

## ğŸ¯ What It Does

Automatically fetches Application Insights data from Azure, analyzes it with Claude Code, and posts a beautiful daily summary to Slack.

## âœ¨ Key Features

### ğŸ“Š Beautiful Slack Reports
- **2-column metrics grid** with emoji icons
- **Top 5 exception problems** with full details
- **Visual bar charts** (â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘) showing relative frequency
- **Code blocks** for readable error details
- **Interactive Azure Portal link**

### ğŸ”„ Automatic Token Refresh
- **Local**: Uses `az account get-access-token` automatically
- **LaunchCode**: Supports Azure Service Principal for auto-refresh
- **Never expires** when properly configured

### ğŸ¤– Claude Code Analysis
- Concise, executive-friendly summaries
- Specific error identification
- Actionable recommendations

## ğŸ“ Files

```
automations/
â”œâ”€â”€ run.sh                      # LaunchCode main script (with Service Principal)
â”œâ”€â”€ test_local.sh               # Local test script (with auto token refresh)
â”œâ”€â”€ refresh_token.sh            # Azure token refresh helper
â”œâ”€â”€ fetch_insights.py           # Fetch data from Azure API
â”œâ”€â”€ post_to_slack.py            # Post to Slack with Block Kit
â”œâ”€â”€ send_slack_message.py       # Generic Slack sender
â”œâ”€â”€ debug_azure.py              # Debug Azure connection
â”œâ”€â”€ Dockerfile                  # Docker image with Node.js + Claude Code
â”œâ”€â”€ .env.example                # Environment variable template
â””â”€â”€ README.md                   # Documentation
```

## ğŸš€ Quick Start

### Local Testing

```bash
# 1. Install dependencies
pip install slack-sdk requests python-dateutil
npm install -g @anthropics/claude-code

# 2. Configure environment
cp .env.example .env
# Edit .env with your credentials

# 3. Run (automatically refreshes token!)
bash test_local.sh
```

### LaunchCode Deployment

The job is already configured in LaunchCode:
- **Name**: LoA Application Insights Summary Job
- **Schedule**: Daily at 8:30 AM EST
- **Status**: Currently disabled (enable when ready)

## ğŸ“Š Slack Message Format

```
ğŸ”´ LoA Application Insights - Daily Summary
January 30, 2026 at 02:17 PM PST
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸš¨ Exceptions      ğŸ“¥ Requests
4,560              0

âœ… Success Rate    âš¡ P95 Response
100%               1,235ms

ğŸ”— Dependencies
2.5M (217 failed)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”¥ Top Exception Problems
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. 2,191Ã— occurrences
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 2,191
```
TypeError at BasketAdQueue.handleLineItemEvents
Cannot set properties of undefined (setting 'voidRequested')
```

[... 4 more issues ...]

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš¡ Action Required
Add null/undefined checks in BasketAdQueue and PromoAdFactory
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ˆ View in Azure Portal | Generated by Claude Code
```

## ğŸ”„ Token Refresh

### Local (Automatic)
The `test_local.sh` script automatically calls `refresh_token.sh` before running:
```bash
# Step 0: Refresh Azure Access Token
./refresh_token.sh  # Gets fresh token via az CLI
export $(grep -v '^#' .env | xargs)  # Reloads environment
```

### LaunchCode (Service Principal)
Set these environment variables for automatic refresh:
```bash
AZURE_TENANT_ID=19da1f3c-d958-44ea-850d-195c15025c
AZURE_CLIENT_ID=<your-app-id>
AZURE_CLIENT_SECRET=<your-secret>
```

The job will automatically get fresh tokens on each run!

## ğŸ¨ Slack Block Kit Features

### Beautiful Metrics Grid
Uses Slack's `fields` feature for 2-column layout:
```json
{
  "type": "section",
  "fields": [
    {"type": "mrkdwn", "text": "*ğŸš¨ Exceptions*\n`4,560`"},
    {"type": "mrkdwn", "text": "*ğŸ“¥ Requests*\n`0`"}
  ]
}
```

### Visual Bar Charts
ASCII bars scaled proportionally:
```
Issue #1: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (100%)
Issue #2: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘ (77%)
Issue #3: â–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ (14%)
```

### Separated Issue Blocks
Each issue gets its own section for better readability on mobile.

### Code Blocks
Triple backticks for exception details:
```
TypeError at BasketAdQueue.handleLineItemEvents
Cannot set properties of undefined
```

## ğŸ“ˆ Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Azure Portal   â”‚
â”‚ App Insights    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ KQL Query
         â”‚ (24h window)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ fetch_insights  â”‚
â”‚     .py         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ JSON Data
         â”‚ (Summary + 50 exceptions + 20 groups)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Claude Code    â”‚
â”‚   Analysis      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Text Report
         â”‚ (Metrics + Top 5 + Action)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ post_to_slack   â”‚
â”‚     .py         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Block Kit JSON
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Slack Channel  â”‚
â”‚ #int-lift-loa-  â”‚
â”‚  app-insights   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ Configuration

### Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `AZURE_APP_INSIGHTS_WORKSPACE_ID` | âœ… | Application ID (not workspace ID) |
| `AZURE_ACCESS_TOKEN` | âœ… | Azure access token (or use Service Principal) |
| `SLACK_BOT_TOKEN` | âœ… | Slack bot token |
| `SLACK_CHANNEL` | âŒ | Slack channel (default: #int-lift-loa-app-insights) |
| `AZURE_TENANT_ID` | âŒ | For automatic token refresh |
| `AZURE_CLIENT_ID` | âŒ | For automatic token refresh |
| `AZURE_CLIENT_SECRET` | âŒ | For automatic token refresh |

### LaunchCode Job Configuration

- **CPU**: 512 units
- **Memory**: 1024 MB
- **Schedule**: `30 8 * * *` (8:30 AM EST daily)
- **Timezone**: America/New_York
- **Enabled**: false (ready to enable)

## ğŸ¯ Key Improvements Made

| Feature | Before | After |
|---------|--------|-------|
| Token Management | Manual refresh every hour | **Automatic refresh** âœ… |
| Issues Shown | Top 3 | **Top 5** âœ… |
| Metrics Display | Single line | **2-column grid** âœ… |
| Visualization | None | **ASCII bar charts** âœ… |
| Error Details | Problem ID only | **Full descriptions** âœ… |
| Slack Format | Plain text | **Block Kit** âœ… |
| Mobile Experience | Hard to read | **Responsive** âœ… |

## ğŸ“ Maintenance

### Refresh Token Manually
```bash
./refresh_token.sh
```

### Test Connection
```bash
export $(grep -v '^#' .env | xargs)
python3 debug_azure.py
```

### Send Test Message
```bash
python3 send_slack_message.py "Test message"
```

### View Logs (LaunchCode)
```bash
~/.launchcode/scripts/api.js <<'EOF'
const runs = await api.runs.list({job_id: "b9084540-4725-4f23-b6c6-9310bb3328b7"});
console.log(runs.runs[0]);
EOF
```

## ğŸ› Troubleshooting

### "Authentication failed - token may be expired"
- Run `./refresh_token.sh` to get a fresh token
- Or set up Azure Service Principal for auto-refresh

### "Job not found" in LaunchCode
- Make sure Application ID is correct: `245ca4b3-2249-4a42-a983-8ec6904f2514`
- Check token is for correct resource: `https://api.applicationinsights.io`

### "No issues showing in Slack"
- Check Claude's output format matches expected pattern
- Look for "Top 5 Problems:" section in the report
- Check debug output in logs

## ğŸš€ Next Steps

1. **Enable LaunchCode Job** - Set `enabled: true` for daily runs
2. **Set Up Service Principal** - For permanent token solution
3. **Configure Alerts** - Add Slack alerts for critical errors
4. **Expand Metrics** - Add custom KQL queries for specific insights

## ğŸ“š Resources

- [Azure Application Insights API](https://dev.applicationinsights.io/)
- [Slack Block Kit Builder](https://api.slack.com/block-kit/building)
- [Claude Code Documentation](https://claude.ai/claude-code)
- [LaunchCode Platform](https://launchcode.ai)

{
  "files": [
    {
      "mode": "755",
      "path": "/app/run.sh",
      "content": "#!/bin/bash\nset -e\n\necho \"=== LoA Application Insights Summary ===\"\necho \"Starting at: $(date)\"\necho \"Timezone: America/New_York\"\necho \"Authentication: Azure Access Token\"\n\n# Configure Claude Code with LaunchCode (if API credentials provided)\nif [ -n \"$LAUNCHCODE_API_URL\" ] && [ -n \"$LAUNCHCODE_API_KEY\" ]; then\n  echo \"üîß Configuring Claude Code with LaunchCode...\"\n  curl -fsSL -H \"X-API-Key: $LAUNCHCODE_API_KEY\" \"$LAUNCHCODE_API_URL/api/claude/setup\" | python3\nfi\n\n# Verify environment variables\necho \"üìã Checking environment variables...\"\n[ -z \"$AZURE_APP_INSIGHTS_WORKSPACE_ID\" ] && echo \"‚ö†Ô∏è  AZURE_APP_INSIGHTS_WORKSPACE_ID not set\"\n[ -z \"$AZURE_ACCESS_TOKEN\" ] && echo \"‚ùå AZURE_ACCESS_TOKEN not set - REQUIRED\"\n[ -z \"$SLACK_BOT_TOKEN\" ] && echo \"‚ùå SLACK_BOT_TOKEN not set - REQUIRED\"\n\nif [ -n \"$AZURE_ACCESS_TOKEN\" ]; then\n  echo \"‚úÖ Azure access token configured\"\n  echo \"‚ÑπÔ∏è  Note: Access tokens expire after 1 hour. Refresh before scheduled runs.\"\nelse\n  echo \"‚ùå No Azure access token found\"\n  exit 1\nfi\n\n# Step 1: Fetch Application Insights data\necho \"üöÄ Step 1: Fetching Application Insights data...\"\npython3 /app/fetch_insights.py > /app/insights_data.json\n\nif [ $? -ne 0 ]; then\n  echo \"‚ùå Failed to fetch Application Insights data\"\n  exit 1\nfi\n\necho \"‚úÖ Data fetched successfully\"\n\n# Step 2: Analyze with Claude Code\necho \"ü§ñ Step 2: Analyzing data with Claude Code...\"\nANALYSIS=$(echo \"You are analyzing Application Insights data for the LoA (Letter of Authorization) application.\n\nHere is the data from the last 24 hours in /app/insights_data.json\n\nPlease provide a concise daily summary report that includes:\n1. Overall health status (Healthy, Warning, Critical)\n2. Key metrics summary (requests, success rate, response times, errors)\n3. Top exception problems with counts and specific error messages\n4. Notable observations or anomalies\n5. Actionable recommendations for each major issue\n\nFormat the response in a clear, readable manner suitable for Slack posting.\nUse emojis appropriately to highlight status (‚úÖ üü° üî¥).\n\nImportant: Output ONLY the report text, no preamble or explanation.\" | claude -p --dangerously-skip-permissions)\n\nif [ $? -ne 0 ]; then\n  echo \"‚ùå Claude Code analysis failed\"\n  exit 1\nfi\n\necho \"‚úÖ Analysis completed\"\n\n# Step 3: Post to Slack\necho \"üì§ Step 3: Posting report to Slack...\"\necho \"$ANALYSIS\" | python3 /app/post_to_slack.py\n\nexit_code=$?\nif [ $exit_code -eq 0 ]; then\n  echo \"‚úÖ Job completed successfully at $(date)\"\nelse\n  echo \"‚ùå Job failed with exit code $exit_code at $(date)\"\nfi\n\nexit $exit_code\n"
    },
    {
      "mode": "755",
      "path": "/app/fetch_insights.py",
      "content": "#!/usr/bin/env python3\n\"\"\"\nFetch Application Insights data from Azure\nOutputs JSON to stdout\n\"\"\"\nimport os\nimport json\nimport requests\nimport sys\n\n# Configuration\nWORKSPACE_ID = os.environ.get('AZURE_APP_INSIGHTS_WORKSPACE_ID')\nACCESS_TOKEN = os.environ.get('AZURE_ACCESS_TOKEN')\n\ndef fetch_app_insights():\n    \"\"\"Fetch Application Insights data for the last 24 hours using REST API\"\"\"\n\n    # KQL query to get summary metrics and detailed exceptions\n    query = \"\"\"\n    let summary = union requests, exceptions, dependencies, traces\n    | where timestamp > ago(24h)\n    | summarize\n        TotalRequests = countif(itemType == 'request'),\n        FailedRequests = countif(itemType == 'request' and success == false),\n        TotalExceptions = countif(itemType == 'exception'),\n        AvgResponseTime = avgif(duration, itemType == 'request'),\n        P95ResponseTime = percentile(duration, 95),\n        TotalDependencies = countif(itemType == 'dependency'),\n        FailedDependencies = countif(itemType == 'dependency' and success == false)\n    | extend SuccessRate = iff(TotalRequests > 0, round(100.0 * (TotalRequests - FailedRequests) / TotalRequests, 2), 100.0)\n    | extend DataType = \"Summary\";\n    let exceptionDetails = exceptions\n    | where timestamp > ago(24h)\n    | project\n        DataType = \"Exception\",\n        timestamp,\n        type,\n        outerMessage,\n        problemId,\n        operation_Name,\n        cloud_RoleName,\n        severityLevel\n    | order by timestamp desc\n    | take 50;\n    let exceptionGroups = exceptions\n    | where timestamp > ago(24h)\n    | summarize\n        Count = count(),\n        LatestOccurrence = max(timestamp),\n        SampleMessage = any(outerMessage)\n        by problemId, type, operation_Name\n    | order by Count desc\n    | take 20\n    | extend DataType = \"ExceptionGroup\";\n    union summary, exceptionDetails, exceptionGroups\n    \"\"\"\n\n    try:\n        # Call Azure Application Insights REST API\n        url = f'https://api.applicationinsights.io/v1/apps/{WORKSPACE_ID}/query'\n        headers = {\n            'Authorization': f'Bearer {ACCESS_TOKEN}',\n            'Content-Type': 'application/json'\n        }\n        payload = {\n            'query': query\n        }\n\n        response = requests.post(url, headers=headers, json=payload, timeout=30)\n        response.raise_for_status()\n\n        result = response.json()\n\n        # Parse results\n        if 'tables' in result and len(result['tables']) > 0:\n            table = result['tables'][0]\n            columns = [col['name'] for col in table['columns']]\n            rows = [dict(zip(columns, row)) for row in table['rows']]\n            return {\"success\": True, \"data\": rows}\n        else:\n            return {\"success\": True, \"data\": [], \"message\": \"No data returned from query\"}\n\n    except requests.exceptions.HTTPError as e:\n        if e.response.status_code == 401:\n            error_msg = \"Authentication failed - token may be expired or invalid\"\n        elif e.response.status_code == 403:\n            error_msg = \"Access denied - insufficient permissions for Application Insights\"\n        else:\n            error_msg = f\"HTTP error {e.response.status_code}: {e.response.text}\"\n        return {\"success\": False, \"error\": error_msg}\n    except Exception as e:\n        return {\"success\": False, \"error\": str(e)}\n\ndef main():\n    \"\"\"Main execution function\"\"\"\n\n    # Validate required environment variables\n    if not ACCESS_TOKEN:\n        print(json.dumps({\"success\": False, \"error\": \"AZURE_ACCESS_TOKEN is required\"}), file=sys.stderr)\n        return 1\n\n    if not WORKSPACE_ID:\n        print(json.dumps({\"success\": False, \"error\": \"AZURE_APP_INSIGHTS_WORKSPACE_ID is required\"}), file=sys.stderr)\n        return 1\n\n    # Fetch data\n    result = fetch_app_insights()\n\n    # Output JSON to stdout\n    print(json.dumps(result, indent=2))\n\n    # Return appropriate exit code\n    return 0 if result.get(\"success\") else 1\n\nif __name__ == '__main__':\n    sys.exit(main())\n"
    },
    {
      "mode": "755",
      "path": "/app/post_to_slack.py",
      "content": "#!/usr/bin/env python3\n\"\"\"\nPost analysis report to Slack\nReads report from stdin\n\"\"\"\nimport os\nimport sys\nfrom datetime import datetime\nfrom slack_sdk import WebClient\nfrom slack_sdk.errors import SlackApiError\n\n# Configuration\nSLACK_CHANNEL = os.environ.get('SLACK_CHANNEL', '#int-lift-loa-app-insights')\nSLACK_TOKEN = os.environ.get('SLACK_BOT_TOKEN')\n\ndef post_to_slack(report):\n    \"\"\"Post the analysis report to Slack\"\"\"\n\n    if not SLACK_TOKEN:\n        print(\"‚ùå SLACK_BOT_TOKEN is required\", file=sys.stderr)\n        return 1\n\n    client = WebClient(token=SLACK_TOKEN)\n\n    try:\n        # Create a formatted message\n        message_text = f\"*LoA Application Insights - Daily Summary*\\n_{datetime.now().strftime('%Y-%m-%d %H:%M %Z')}_\\n\\n{report}\"\n\n        response = client.chat_postMessage(\n            channel=SLACK_CHANNEL,\n            text=message_text,\n            mrkdwn=True\n        )\n\n        print(f\"‚úÖ Message posted successfully to {SLACK_CHANNEL}\")\n        return 0\n\n    except SlackApiError as e:\n        print(f\"‚ùå Error posting to Slack: {e.response['error']}\", file=sys.stderr)\n        return 1\n    except Exception as e:\n        print(f\"‚ùå Unexpected error: {str(e)}\", file=sys.stderr)\n        return 1\n\ndef main():\n    \"\"\"Main execution function\"\"\"\n\n    # Read report from stdin\n    report = sys.stdin.read().strip()\n\n    if not report:\n        print(\"‚ùå No report content received from stdin\", file=sys.stderr)\n        return 1\n\n    return post_to_slack(report)\n\nif __name__ == '__main__':\n    sys.exit(main())\n"
    }
  ],
  "dockerfile": "# Use Amazon ECR to avoid Docker Hub rate limits\nFROM public.ecr.aws/docker/library/python:3.11-slim\n\n# Install system dependencies including Node.js for Claude Code\nRUN apt-get update && apt-get install -y --no-install-recommends \\\n    bash \\\n    curl \\\n    ca-certificates \\\n    nodejs \\\n    npm \\\n    && rm -rf /var/lib/apt/lists/*\n\n# Install Claude Code CLI\nRUN npm install -g @anthropics/claude-code\n\n# Install Python dependencies (no longer need anthropic SDK)\nRUN pip install --no-cache-dir \\\n    slack-sdk \\\n    requests \\\n    python-dateutil\n\n# Set working directory\nWORKDIR /app\n\n# Set shell to bash\nSHELL [\"/bin/bash\", \"-c\"]\n\nCMD [\"bash\", \"/app/run.sh\"]\n"
}
